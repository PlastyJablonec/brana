<!DOCTYPE html>
<html>
<head>
    <title>MQTT Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: white; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .success { background: #0f5132; }
        .error { background: #842029; }
        .info { background: #0c4a6e; }
        .warning { background: #664d03; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #0d6efd; color: white; border: none; border-radius: 5px; }
        input { padding: 8px; margin: 5px; width: 200px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .command-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîå MQTT Debug Test - Br√°na Control</h1>
        
        <div>
            <button onclick="connectMQTT()">Connect MQTT</button>
            <button onclick="disconnect()">Disconnect</button>
            <button onclick="clearResults()">Clear Log</button>
        </div>
        
        <div class="command-grid">
            <button onclick="sendCommand('1')">Br√°na OTEV≈òI (1)</button>
            <button onclick="sendCommand('2')">Br√°na ZAV≈òI (2)</button>
            <button onclick="sendCommand('3')">Gar√°≈æ OTEV≈òI (3)</button>
            <button onclick="sendCommand('4')">Gar√°≈æ ZAV≈òI (4)</button>
            <button onclick="sendCommand('5')">Gar√°≈æ STOP (5)</button>
            <button onclick="sendCommand('6')">STOP Re≈æim (6)</button>
        </div>
        
        <div>
            <input type="text" id="customCommand" placeholder="Custom command" value="">
            <button onclick="sendCustomCommand()">Send Custom</button>
        </div>
        
        <div id="results"></div>
    </div>

    <script src="https://unpkg.com/mqtt@5.13.3/dist/mqtt.min.js"></script>

    <script>
        let client = null;
        let isConnected = false;

        const MQTT_CONFIG = {
            broker: 'ws://89.24.76.191:9001',
            options: {
                clientId: 'mqtt-debug-' + Math.random().toString(16).substr(2, 8),
                keepalive: 30,
                protocolVersion: 4,
                reconnectPeriod: 1000,
                connectTimeout: 30000,
                clean: true
            }
        };

        window.connectMQTT = function() {
            if (isConnected) {
                addResult('warning', '‚ö†Ô∏è Already connected to MQTT');
                return;
            }

            addResult('info', `üîå Connecting to MQTT broker: ${MQTT_CONFIG.broker}`);
            addResult('info', `üìã Client ID: ${MQTT_CONFIG.options.clientId}`);

            try {
                client = mqtt.connect(MQTT_CONFIG.broker, MQTT_CONFIG.options);

                client.on('connect', () => {
                    isConnected = true;
                    addResult('success', '‚úÖ MQTT Connected successfully!');
                    
                    // Subscribe to status topics
                    client.subscribe('IoT/Brana/Status', (err) => {
                        if (err) {
                            addResult('error', `‚ùå Failed to subscribe to IoT/Brana/Status: ${err.message}`);
                        } else {
                            addResult('success', 'üì° Subscribed to IoT/Brana/Status');
                        }
                    });
                    
                    client.subscribe('IoT/Brana/Status2', (err) => {
                        if (err) {
                            addResult('error', `‚ùå Failed to subscribe to IoT/Brana/Status2: ${err.message}`);
                        } else {
                            addResult('success', 'üì° Subscribed to IoT/Brana/Status2');
                        }
                    });

                    // Subscribe to all IoT topics for debugging
                    client.subscribe('IoT/#', (err) => {
                        if (err) {
                            addResult('error', `‚ùå Failed to subscribe to IoT/#: ${err.message}`);
                        } else {
                            addResult('info', 'üì° Subscribed to IoT/# (all topics)');
                        }
                    });
                });

                client.on('message', (topic, message) => {
                    const msg = message.toString();
                    addResult('info', `üì® Received: ${topic} = "${msg}"`);
                });

                client.on('error', (error) => {
                    addResult('error', `‚ùå MQTT Error: ${error.message}`);
                    isConnected = false;
                });

                client.on('close', () => {
                    addResult('warning', 'üîå MQTT Connection closed');
                    isConnected = false;
                });

                client.on('reconnect', () => {
                    addResult('info', 'üîÑ MQTT Reconnecting...');
                });

                client.on('offline', () => {
                    addResult('warning', 'üì¥ MQTT Client offline');
                    isConnected = false;
                });

            } catch (error) {
                addResult('error', `‚ùå MQTT Setup Error: ${error.message}`);
            }
        };

        window.sendCommand = function(command) {
            if (!isConnected || !client) {
                addResult('error', '‚ùå MQTT not connected! Click "Connect MQTT" first.');
                return;
            }

            const topic = 'IoT/Brana/Ovladani';
            const commandNames = {
                '1': 'Br√°na OTEV≈òI',
                '2': 'Br√°na ZAV≈òI', 
                '3': 'Gar√°≈æ OTEV≈òI',
                '4': 'Gar√°≈æ ZAV≈òI',
                '5': 'Gar√°≈æ STOP',
                '6': 'STOP Re≈æim'
            };

            addResult('info', `üì§ Sending command: ${command} (${commandNames[command] || 'Unknown'}) to ${topic}`);

            client.publish(topic, command, { qos: 1 }, (error) => {
                if (error) {
                    addResult('error', `‚ùå Failed to send command: ${error.message}`);
                } else {
                    addResult('success', `‚úÖ Command "${command}" sent successfully!`);
                }
            });
        };

        window.sendCustomCommand = function() {
            const command = document.getElementById('customCommand').value;
            if (!command) {
                addResult('warning', '‚ö†Ô∏è Enter custom command first');
                return;
            }
            sendCommand(command);
        };

        window.disconnect = function() {
            if (client) {
                client.end();
                client = null;
                isConnected = false;
                addResult('info', 'üîå MQTT Disconnected');
            }
        };

        window.clearResults = function() {
            document.getElementById('results').innerHTML = '';
        };

        function addResult(type, message) {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        // Auto-connect on load
        window.onload = function() {
            addResult('info', 'üöÄ MQTT Debug Tool loaded');
            addResult('info', 'üìã Commands: 1=Br√°na otev≈ôi, 2=Br√°na zav≈ôi, 3=Gar√°≈æ otev≈ôi, 4=Gar√°≈æ zav≈ôi, 5=Gar√°≈æ stop, 6=STOP re≈æim');
        };
    </script>
</body>
</html>